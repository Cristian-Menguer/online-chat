<!doctype html>
<html lang="en">

<head>
  <title>Chat</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="index.css">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>

  <form id="chat">
    <input type="text" class="form-control" name="username" id="username" placeholder="Type your Name" />

    <div class="messages"></div>

    <input type="text" class="form-control" name="message" id="message" placeholder="Type your Message" />

    <button type="submit">Send</button>
  </form>

  <script type="module">

    const socket = io()

    socket.on('connect', () => {

      const socketId = socket.id

      socket.on('load-messages', (messages) => {

        for (const message of messages) {
          renderMessage(message)
        }

      })

    })

    socket.on('new-message', (message) => {

      renderMessage(message)

    })

    $('#chat').submit(function (event) {

      event.preventDefault()

      let author = $('#username').val()
      let message = $('#message').val()
      let time = new Date().getHours() + ':' + ("0" + new Date().getMinutes()).slice(-2)

      if (author.length && message.length) {

        const msgObj = {
          author: author,
          message: message,
          time: time
        }

        socket.emit('new-message', msgObj)

        renderMessage(msgObj)

        $('#message').val('')
    }

    })

    function renderMessage(message) {
      $('.messages').append(`<div class="message">(${message.time}) <strong>${message.author}</strong>: ${message.message}</div>`)
    }

  </script>

</body>

</html>